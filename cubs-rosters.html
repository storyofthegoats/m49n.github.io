<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>cubs rosters · m49n</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 40px 20px;
        font-family: "JetBrains Mono", ui-monospace, Menlo, Monaco, Consolas,
          "Courier New", monospace;
        background: #050505;
        color: #e5e5e5;
      }

      main {
        max-width: 960px;
        margin: 0 auto;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      .top-link {
        font-size: 0.8rem;
        color: #777;
        margin-bottom: 12px;
        display: inline-block;
      }

      .title {
        font-size: 1.3rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-bottom: 4px;
      }

      .subtitle {
        font-size: 0.9rem;
        color: #888;
        margin-bottom: 18px;
        line-height: 1.6;
      }

      .divider {
        border: none;
        border-top: 1px solid #222;
        margin: 0 0 24px 0;
      }

      .section-label {
        font-size: 0.8rem;
        color: #777;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        margin-bottom: 12px;
      }

      .roster-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .year-panel {
        border: 1px solid #111;
        border-radius: 10px;
        overflow: hidden;
        background: radial-gradient(circle at top left, #0d0d0d 0, #040404 70%);
      }

      .year-panel[open] {
        border-color: #1f1f1f;
        box-shadow: 0 0 0 1px #0f0f0f;
      }

      .year-summary {
        padding: 12px 14px;
        font-size: 1rem;
        letter-spacing: 0.04em;
        cursor: pointer;
        list-style: none;
      }

      .year-summary::-webkit-details-marker {
        display: none;
      }

      .year-summary::after {
        content: "↓";
        float: right;
        color: #4af626;
      }

      .year-panel[open] .year-summary::after {
        content: "↑";
      }

      .roster-content {
        padding: 0 14px 14px 14px;
        font-size: 0.9rem;
        color: #cfcfcf;
      }

      .roster-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }

      .roster-item {
        border: 1px solid #151515;
        border-radius: 8px;
        padding: 10px;
        background: #0a0a0a;
      }

      .roster-name {
        font-size: 0.95rem;
      }

      .roster-meta {
        font-size: 0.8rem;
        color: #888;
        margin-top: 4px;
      }

      .footer {
        font-size: 0.75rem;
        color: #666;
        margin-top: 24px;
      }

      .back-footer {
        display: block;
        margin-top: 12px;
        padding: 12px 14px;
        background: #4af626;
        color: #050505;
        text-align: center;
        font-weight: 600;
        border-radius: 10px;
      }

      .back-footer:hover {
        text-decoration: none;
        opacity: 0.9;
      }

      @media (max-width: 600px) {
        body {
          padding: 28px 16px;
        }

        .year-summary {
          font-size: 0.95rem;
        }
      }
    </style>
  </head>

  <body>
    <main>
      <a class="top-link" href="cards.html">← cards</a>

      <header>
        <div class="title">cubs rosters</div>
        <div class="subtitle">
          every Chicago Cub on the roster, listed year by year from the 2025
          season back to 1904. Expand a season to load the names, numbers, and
          positions directly from MLB's public stats API.
        </div>
        <hr class="divider" />
      </header>

      <section>
        <div class="section-label">rosters by year</div>
        <div id="roster-list" class="roster-list"></div>
      </section>

      <div class="footer">m49n · cubs rosters</div>
      <a class="back-footer" href="index.html">← back to index</a>
    </main>

    <script>
      const rosterList = document.getElementById("roster-list");
      const years = Array.from(
        { length: 2025 - 1904 + 1 },
        (_, index) => 2025 - index
      );

      years.forEach((year) => {
        const details = document.createElement("details");
        details.className = "year-panel";

        const summary = document.createElement("summary");
        summary.className = "year-summary";
        summary.textContent = year;
        details.appendChild(summary);

        const content = document.createElement("div");
        content.className = "roster-content";
        content.textContent = "Open to load roster...";
        details.appendChild(content);

        let loaded = false;
        details.addEventListener("toggle", () => {
          if (details.open && !loaded) {
            loaded = true;
            loadRoster(year, content);
          }
        });

        rosterList.appendChild(details);
      });

      async function loadRoster(year, target) {
        target.textContent = "Loading roster...";

        try {
          const response = await fetch(
            `https://statsapi.mlb.com/api/v1/teams/112/roster?rosterType=fullSeason&season=${year}`
          );

          if (!response.ok) {
            throw new Error("Network response was not ok");
          }

          const data = await response.json();
          const roster = data.roster || [];

          if (!roster.length) {
            target.textContent = "No roster data available for this season.";
            return;
          }

          roster.sort((a, b) => sortRoster(a, b));

          const battingAverages = await fetchBattingAverages(roster, year);
          const topBattingAverage = Math.max(
            ...Object.values(battingAverages).map((value) =>
              Number.isFinite(value) ? value : -Infinity
            )
          );

          const grid = document.createElement("div");
          grid.className = "roster-grid";

          roster.forEach((player) => {
            const card = document.createElement("div");
            card.className = "roster-item";

            const name = document.createElement("div");
            name.className = "roster-name";
            const playerName = player.person?.fullName || "Unknown";
            const wikiLink = getWikiLink(playerName);
            const nameContent = wikiLink
              ? document.createElement("a")
              : document.createElement("span");

            if (wikiLink) {
              nameContent.href = wikiLink;
              nameContent.textContent = playerName;
            } else {
              nameContent.textContent = playerName;
            }

            const avg = battingAverages[player.person?.id] ?? null;
            if (avg === topBattingAverage && Number.isFinite(avg)) {
              name.style.color = "#4af626";
            }

            name.appendChild(nameContent);

            const meta = document.createElement("div");
            meta.className = "roster-meta";
            const number = player.jerseyNumber ? `#${player.jerseyNumber}` : "#—";
            const position = player.position?.abbreviation || "—";
            meta.textContent = `${number} · ${position}`;

            card.appendChild(name);
            card.appendChild(meta);
            grid.appendChild(card);
          });

          target.innerHTML = "";
          target.appendChild(grid);
        } catch (error) {
          target.textContent = `Could not load roster for ${year}.`;
        }
      }

      function sortRoster(a, b) {
        const posA = a.position?.abbreviation || "";
        const posB = b.position?.abbreviation || "";

        const isPitcherA = posA === "P";
        const isPitcherB = posB === "P";

        if (isPitcherA !== isPitcherB) {
          return isPitcherA ? 1 : -1;
        }

        if (posA !== posB) {
          return posA.localeCompare(posB);
        }

        return a.person.fullName.localeCompare(b.person.fullName);
      }

      async function fetchBattingAverages(roster, year) {
        const results = await Promise.all(
          roster.map(async (player) => {
            const id = player.person?.id;
            if (!id) return [null, null];

            try {
              const response = await fetch(
                `https://statsapi.mlb.com/api/v1/people/${id}/stats?stats=season&season=${year}&group=hitting`
              );

              if (!response.ok) {
                return [id, null];
              }

              const statsData = await response.json();
              const avgString =
                statsData?.stats?.[0]?.splits?.[0]?.stat?.avg ?? null;
              const avgNumber = avgString ? Number(avgString) : null;
              return [id, Number.isFinite(avgNumber) ? avgNumber : null];
            } catch (error) {
              return [id, null];
            }
          })
        );

        return Object.fromEntries(results.filter(([id]) => id !== null));
      }

      function getWikiLink(name) {
        const wikiMap = {
          "Anthony Rizzo": "https://en.wikipedia.org/wiki/Anthony_Rizzo",
          "David Ross": "https://en.wikipedia.org/wiki/David_Ross_(baseball)",
          "Kris Bryant": "https://en.wikipedia.org/wiki/Kris_Bryant",
          "Pete Crow-Armstrong": "https://en.wikipedia.org/wiki/Pete_Crow-Armstrong",
          "Ryne Sandberg": "https://en.wikipedia.org/wiki/Ryne_Sandberg",
        };

        return wikiMap[name] || null;
      }
    </script>
  </body>
</html>
